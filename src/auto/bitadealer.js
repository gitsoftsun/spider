var brands = [{"brand":"奥迪","path":"/audi/"},
{"brand":"阿斯顿·马丁","path":"/astonmartin/"},
{"brand":"阿尔法·罗密欧","path":"/alfaromeo/"},
{"brand":"AC Schnitzer","path":"/acschnitzer/"},
{"brand":"本田","path":"/honda/"},
{"brand":"别克","path":"/buick/"},
{"brand":"宝马","path":"/bmw/"},
{"brand":"比亚迪","path":"/bydauto/"},
{"brand":"奔驰","path":"/mercedesbenz/"},
{"brand":"标致","path":"/peugeot/"},
{"brand":"保时捷","path":"/porsche/"},
{"brand":"奔腾","path":"/besturn/"},
{"brand":"北汽幻速","path":"/beiqihuansu/"},
{"brand":"宝骏","path":"/bj/"},
{"brand":"北京汽车","path":"/bjqc/"},
{"brand":"北汽威旺","path":"/ww/"},
{"brand":"北汽制造","path":"/beijingjeep/"},
{"brand":"宾利","path":"/bentley/"},
{"brand":"布加迪","path":"/bugatti/"},
{"brand":"巴博斯","path":"/barbus/"},
{"brand":"北汽新能源","path":"/beiqixinnengyuan/"},
{"brand":"保斐利","path":"/bufori/"},
{"brand":"长安轿车","path":"/cajc/"},
{"brand":"长城","path":"/greatwall/"},
{"brand":"长安商用","path":"/casyc/"},
{"brand":"昌河","path":"/changheauto/"},
{"brand":"成功","path":"/chenggong/"},
{"brand":"大众","path":"/volkswagen/"},
{"brand":"东风风行","path":"/fengxingauto/"},
{"brand":"东风小康","path":"/dongfengxiaokang-205/"},
{"brand":"东风风神","path":"/fs/"},
{"brand":"DS","path":"/ds/"},
{"brand":"东南","path":"/southeastautomobile/"},
{"brand":"道奇","path":"/dodge/"},
{"brand":"东风风度","path":"/dongfengfengdu/"},
{"brand":"东风御风","path":"/dongfengyufeng/"},
{"brand":"丰田","path":"/toyota/"},
{"brand":"福特","path":"/ford/"},
{"brand":"菲亚特","path":"/fiat/"},
{"brand":"法拉利","path":"/ferrari/"},
{"brand":"福田","path":"/foton/"},
{"brand":"福迪","path":"/foday/"},
{"brand":"飞驰商务车","path":"/feichishangwuche/"},
{"brand":"福汽启腾","path":"/fujianxinlongmaqichegufenyouxiangongsi/"},
{"brand":"菲斯克","path":"/fisker/"},
{"brand":"Faralli Mazzanti","path":"/farallimazzanti/"},
{"brand":"弗那萨利","path":"/fornasari/"},
{"brand":"广汽","path":"/gq/"},
{"brand":"广汽吉奥","path":"/gonow/"},
{"brand":"观致汽车","path":"/qorosauto/"},
{"brand":"GMC","path":"/gmc-109/"},
{"brand":"光冈","path":"/galue/"},
{"brand":"广汽日野","path":"/guangqihinomotors/"},
{"brand":"哈弗","path":"/hafu-196/"},
{"brand":"海马","path":"/hama/"},
{"brand":"红旗","path":"/faw-hongqi/"},
{"brand":"华泰","path":"/huataiautomobile/"},
{"brand":"黄海","path":"/sgautomotive/"},
{"brand":"哈飞","path":"/hafeiautomobile/"},
{"brand":"海马商用车","path":"/fstar/"},
{"brand":"海格","path":"/higer/"},
{"brand":"华颂","path":"/huasong/"},
{"brand":"恒天汽车","path":"/chtc/"},
{"brand":"汇众","path":"/shanghaihuizhong-45/"},
{"brand":"吉利汽车","path":"/geely/"},
{"brand":"江淮","path":"/jac/"},
{"brand":"Jeep","path":"/jeep/"},
{"brand":"捷豹","path":"/jauger/"},
{"brand":"江铃","path":"/jmc/"},
{"brand":"金杯","path":"/jinbei/"},
{"brand":"江南","path":"/jiangnanauto/"},
{"brand":"九龙","path":"/joylongautomobile/"},
{"brand":"金龙联合","path":"/kinglongmotor/"},
{"brand":"金旅客车","path":"/jlkc/"},
{"brand":"江西五十铃","path":"/jiangxiwushiling/"},
{"brand":"江铃集团轻汽","path":"/jianglingjituanqingqi/"},
{"brand":"凯迪拉克","path":"/cadillac/"},
{"brand":"克莱斯勒","path":"/chrysler/"},
{"brand":"卡威","path":"/kawei/"},
{"brand":"凯翼","path":"/kaiyi/"},
{"brand":"科瑞斯的","path":"/keruisi/"},
{"brand":"开瑞","path":"/karry/"},
{"brand":"科尼赛克","path":"/koenigsegg/"},
{"brand":"KTM","path":"/ktm/"},
{"brand":"卡尔森","path":"/kaersen/"},
{"brand":"铃木","path":"/suzuki/"},
{"brand":"路虎","path":"/landrover/"},
{"brand":"雷克萨斯","path":"/lexus/"},
{"brand":"林肯","path":"/lincoln/"},
{"brand":"力帆","path":"/lifanmotors/"},
{"brand":"陆风","path":"/landwind/"},
{"brand":"兰博基尼","path":"/lamborghini/"},
{"brand":"雷诺","path":"/renult/"},
{"brand":"猎豹汽车","path":"/cf/"},
{"brand":"劳斯莱斯","path":"/rolls-royce/"},
{"brand":"莲花","path":"/lotus-146/"},
{"brand":"理念","path":"/everus/"},
{"brand":"路特斯","path":"/lotus/"},
{"brand":"蓝海房车","path":"/hailanfangche/"},
{"brand":"马自达","path":"/mazda/"},
{"brand":"MG","path":"/mg-79/"},
{"brand":"玛莎拉蒂","path":"/maserati/"},
{"brand":"MINI","path":"/mini/"},
{"brand":"迈凯伦","path":"/mclaren/"},
{"brand":"摩根","path":"/morgancars/"},
{"brand":"纳智捷","path":"/luxgen/"},
{"brand":"讴歌","path":"/acura/"},
{"brand":"欧宝","path":"/opel/"},
{"brand":"欧朗","path":"/ol/"},
{"brand":"起亚","path":"/kia/"},
{"brand":"奇瑞","path":"/chery/"},
{"brand":"启辰","path":"/venucia/"},
{"brand":"庆铃","path":"/isuzu/"},
{"brand":"乔治·巴顿","path":"/qiaozhibadun/"},
{"brand":"日产","path":"/nissan/"},
{"brand":"荣威","path":"/roewe/"},
{"brand":"瑞麒","path":"/riich/"},
{"brand":"斯柯达","path":"/skoda/"},
{"brand":"三菱","path":"/mitsubishi/"},
{"brand":"斯巴鲁","path":"/subaru/"},
{"brand":"绅宝","path":"/shenbao/"},
{"brand":"双龙","path":"/ssangyong/"},
{"brand":"上汽大通MAXUS","path":"/maxus/"},
{"brand":"smart","path":"/smart/"},
{"brand":"山姆","path":"/sam/"},
{"brand":"世爵","path":"/sj/"},
{"brand":"陕汽通家","path":"/tongjia/"},
{"brand":"特斯拉","path":"/tesla/"},
{"brand":"泰卡特","path":"/techart/"},
{"brand":"腾势","path":"/denza/"},
{"brand":"五菱","path":"/sgmw/"},
{"brand":"沃尔沃","path":"/volvo/"},
{"brand":"潍柴英致","path":"/enranger/"},
{"brand":"威麟","path":"/rely/"},
{"brand":"威兹曼","path":"/wiesmann/"},
{"brand":"现代","path":"/hyundai/"},
{"brand":"雪佛兰","path":"/chevrolet/"},
{"brand":"雪铁龙","path":"/citroen/"},
{"brand":"星客特","path":"/xkt/"},
{"brand":"西雅特","path":"/seat/"},
{"brand":"新凯","path":"/xinkaiauto/"},
{"brand":"一汽","path":"/faw/"},
{"brand":"英菲尼迪","path":"/infiniti/"},
{"brand":"野马汽车","path":"/ym/"},
{"brand":"依维柯","path":"/iveco/"},
{"brand":"永源","path":"/jonwayautomobile/"},
{"brand":"扬州亚星客车","path":"/yangzhouyaxingkeche/"},
{"brand":"众泰","path":"/zotyeauto/"},
{"brand":"中华","path":"/brillianceauto/"},
{"brand":"中兴","path":"/zxauto/"},
{"brand":"中欧","path":"/zoemo/"},
{"brand":"浙江卡尔森","path":"/zhejiangkaersen/"},
{"brand":"之诺","path":"/zhinuo/"},
{"brand":"中通客车","path":"/zhongtongkeche/"}]

var fs = require('fs')
var helper = require('../../helpers/webhelper.js')
var cheerio = require('cheerio')
var url = require('url')

var Dealer = function(){
    this.resultDir = "../../result/";
    this.dataDir = '../../appdata/';
    this.resultFile = "bitadealer.txt";
    this.progressFile = "bitadealer_progress.txt";
    this.done = {};
    this.curPageIdx = 1;
    this.tasks = [];
}
//http://deal.autohome.com.cn/china/?k=2, 综合经销商

Dealer.prototype.init = function(){
    if(fs.existsSync(this.resultDir+this.progressFile)){
	fs.readFileSync(this.resultDir+this.progressFile).toString().split('\n').reduce(function(pre,cur){
	    if(cur){
		pre[cur]=true;
	    }
	    return pre;
	},this.done);
    }
    for(var i=0;i<brands.length;i++){
	var brand = brands[i];
	for(var j=1;j<4;j++){
	    this.tasks.push({path:brand.path,name:brand.brand,page:1,mode:j,id:undefined,audit:true});
	}
    }
    console.log("[INFO] task count: %d",this.tasks.length);
}

Dealer.prototype.start = function(){
    this.init();
    this.wgetList();
}

Dealer.prototype.wgetList = function(t){
    if(!t){
	var t = null;
	do{
	    t = this.tasks.shift();
	}
	while(this.tasks.length && this.done[t.name+'-'+t.mode])
	if(!t){
	    console.log("[DONE] job done");
	    return;
	}
    }
    
    var host = "dealer.bitauto.com";
    var path = t.path;
    
    var opt = null;
    if(!t.id){
	opt = new helper.basic_options(host,path,"GET",false,false,{"BizModes":t.mode});
    }else{
	opt = new helper.basic_options(host,"/DealerList.aspx","GET",false,false,{"BizModes":t.mode,"page":t.page,"mbid":t.id});
    }
    opt.agent = false;
    console.log("[GET ] %s,%d/%d,%s",t.name,t.page,t.maxPage,t.mode);
    helper.request_data(opt,null,function(data,args,res){
	that.processList(data,args,res);
    },t);
}
var Task = function(){
    this.max=10;
    this.len=0;
    this.tasks = [];
}
Task.prototype.onEnd = function(){
    
}
Task.prototype.onStart = function(){
    
}
Task.prototype.add = function(ts){
    if(Array.isArray(ts)){
	this.tasks.concat(ts);
    }
}
Task.prototype.invoke = function(){
    
}
    
Dealer.prototype.processList = function(data,args,res){
    if(!data){
	console.log("[ERROR] data empty");
	setTimeout(function(){
	    that.wgetList(args[0]);
	},3000);
	return;
    }
    var $ = cheerio.load(data);
    if(!args[0].id){
	var nextPage = $(".the_pages a").last();
	if(nextPage){
	    args[0].maxPage = Number(nextPage.prev().text());
	    var q = url.parse("http://dealer.bitauto.com"+nextPage.attr("href"),true).query;
	    args[0].id = q.mbid;
	}else{
	    args[0].maxPage = 1;
	}
    }
    
    var records = [""];
    var idx = -1;
    if(args[0].audit == true){
	$("ul.jxs-list li.no-car-list").each(function(i){
	    if($(this).attr('style') == "display: block;"){
		args[0].audit = false;
		idx=i;
		return false;
	    }
	});
    }
    
    $("ul.jxs-list li.clearfix").each(function(j){
	var name = $("div.intro-box .p-tit a",this).attr('title');
	name = name && name.replace(/[,，]/g,"");
	var brand = $(".intro-box .p-intro .add-sty",this).first().text();
	var city = $(".infor-box .price-city",this).text().trim().split(/\s+/)[0];
	var phone = $(".intro-box .p-intro span.phone-sty span.tel400",this).text();
	if(!phone){
	    phone = $(".intro-box .p-intro span.phone-sty",this).contents().first().text().trim()||"无";
	}
	var audit = $(".intro-box .p-intro span.phone-sty b.rz-phone",this).length;
	var shopAudit = (args[0].audit || j<idx)?"Y":"N";
	records.push([args[0].name,name,brand,city,phone,audit?"Y":"N",shopAudit,args[0].mode==2?"4S":args[0].mode==1?"综合店":"特许店"].join('\t'));
    });
    
    fs.appendFileSync(this.resultDir+this.resultFile,records.join('\n'));
    
    if(args[0].page<args[0].maxPage){
	args[0].page++;
	setTimeout(function(){
	    that.wgetList(args[0]);
	},0);
    }else{
	console.log("[DONE] %s,%s",args[0].name,args[0].mode);
	fs.appendFileSync(this.resultDir+this.progressFile,args[0].name+'-'+args[0].mode+"\n");
	this.wgetList();
    }
}

var instance = new Dealer();
var that = instance;
instance.start();